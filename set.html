<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق الأسعار</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/@zxing/library@latest/umd/index.min.js"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <style>
        /* General Styles */
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
            background-color: #f8f9fa;
        }

        #reader {
            width: 100%;
            max-width: 400px;
            height: 300px;
            margin: auto;
            border: 2px solid #ccc;
            border-radius: 5px;
            overflow: hidden;
            display: none;
            position: relative;
        }

        #reader video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #priceDisplay {
            font-size: 2.5rem;
            font-weight: bold;
            color: green;
            text-align: center;
            margin: 20px 0;
        }

        .button-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            max-width: 400px;
            margin-top: 20px;
        }

        .button-container button {
            width: 100%;
        }

        .alert {
            margin-bottom: 20px; /* Add margin below notifications */
        }
    </style>
</head>
<body>
    <!-- Negative Tone Sound Element -->
    <audio id="negativeToneSound" preload="auto">
        <source src="sounds/Negative-tone-sound-effect.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>
    <!-- Beep Sound Element -->
    <audio id="beepSound" preload="auto">
        <source src="sounds/Barcode-scanner-beep-sound.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <div class="container">
        <h2 class="text-center mb-4">تطبيق الأسعار</h2>
        <form id="crudForm" class="shadow p-4 rounded border">
            <!-- Notifications (Alerts) -->
            <div id="message"></div>

            <!-- Barcode Input Field -->
            <div class="mb-3">
                <input type="text" class="form-control" id="barcode" name="barcode" required placeholder="الباركود">
            </div>

            <!-- Barcode Scanner -->
            <div id="reader" class="mt-4">
                <video id="video"></video>
            </div>

            <!-- Price Input Field -->
            <div class="mb-3">
                <input type="number" step="0.01" class="form-control" id="price" name="price" required placeholder="السعر">
            </div>

            <!-- Price Display -->
            <div id="priceDisplay">
                <span id="priceValue">0.00</span> DZ
            </div>

            <!-- Buttons -->
            <div class="button-container">
                <button type="button" class="btn btn-secondary" id="scanBarcode">مسح الباركود</button>
                <button type="button" class="btn btn-outline-danger" id="resetForm">إعادة تعيين</button>
                <button type="button" class="btn btn-primary action-btn" value="create">إنشاء</button>
                <button type="button" class="btn btn-info action-btn" value="read">قراءة</button>
                <button type="button" class="btn btn-warning action-btn" value="update">تحديث</button>
                <button type="button" class="btn btn-danger action-btn" value="delete">حذف</button>
                <a href="index3.html" class="btn btn-default action-btn">test</a>
            </div>
        </form>

        <!-- Product List -->
        <div id="productList" class="mt-4"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>

    <script>
        $(document).ready(function () {
            const beepSound = document.getElementById('beepSound');
            const negativeToneSound = document.getElementById('negativeToneSound');
            negativeToneSound.volume = 0.01; // Lower the volume of the negative tone sound
            negativeToneSound.loop = true; // Set the negative sound to loop
            let codeReader;
            let scanTimeout; // To store the timeout for scanning
        
            // Initialize Dexie.js
            const db = new Dexie("ProductDatabase");
            db.version(1).stores({
                products: '++id,barcode,price'
            });
        
            // Function to replace commas with dots in the input
            function replaceCommaWithDot(value) {
                return value.replace(/,/g, '.');
            }
        
            // Function to play the negative tone sound
            function playNegativeSound() {
                negativeToneSound.play().catch(error => {
                    console.error("Error playing negative sound:", error);
                });
            }
        
            // Function to stop the negative tone sound
            function stopNegativeSound() {
                negativeToneSound.pause();
                negativeToneSound.currentTime = 0; // Reset the sound to the beginning
            }
        
            // Update the price display
            $('#price').on('input', function () {
                const price = $(this).val();
                // Replace commas with dots in the input
                const formattedPrice = replaceCommaWithDot(price);
                // Update the green price display with the exact value
                $('#priceValue').text(formattedPrice || '0.00');
            });
        
            // Reset the form
            $('#resetForm').on('click', function () {
                $('#barcode').val('');
                $('#price').val('');
                $('#priceValue').text('0.00'); // Reset to 0.00
                $('#message').html('');
                $('#productList').html('');
                $('#reader').hide();
                if (codeReader) {
                    codeReader.reset(); // Stop ZXing
                }
                stopNegativeSound(); // Stop the negative tone
                clearTimeout(scanTimeout); // Clear the scanning timeout
                $('#message').html('<div class="alert alert-info">تم إعادة تعيين النموذج بنجاح.</div>');
            });
        
            // Initialize barcode scanning with ZXing
            $('#scanBarcode').on('click', function () {
                $('#reader').show();
        
                // Play the negative sound in a loop when the camera starts
                playNegativeSound();
        
                // Start a timeout for scanning
                scanTimeout = setTimeout(function () {
                    // If no barcode is detected within 10 seconds, stop the scanner
                    $('#message').html('<div class="alert alert-warning">فشل في الكشف عن الباركود. يرجى المحاولة مرة أخرى.</div>');
                    stopNegativeSound(); // Stop the negative sound
                    codeReader.reset(); // Stop ZXing
                    $('#reader').hide(); // Hide the scanner
                }, 10000); // 10 seconds timeout
        
                codeReader = new ZXing.BrowserMultiFormatReader();
                console.log('ZXing code reader initialized');
        
                // List available video devices and use the back camera
                codeReader.listVideoInputDevices()
                    .then(videoInputDevices => {
                        if (videoInputDevices.length > 0) {
                            // Find the back camera
                            const backCamera = videoInputDevices.find(device => device.label.toLowerCase().includes('back') || device.label.toLowerCase().includes('rear') || device.label.toLowerCase().includes('environment'));
                            const deviceId = backCamera ? backCamera.deviceId : videoInputDevices[0].deviceId; // Use back camera if found, else use the first camera
                            codeReader.decodeFromVideoDevice(deviceId, 'video', (result, err) => {
                                if (result) {
                                    console.log("Barcode detected:", result.text);
                                    $('#barcode').val(result.text);
                                    $('#message').html('<div class="alert alert-success">تم الكشف عن الباركود بنجاح!</div>');
        
                                    // Play the beep sound
                                    beepSound.play().catch(error => {
                                        console.error("Error playing beep sound:", error);
                                    });
        
                                    // Stop ZXing
                                    codeReader.reset();
                                    $('#reader').hide();
        
                                    // Stop the negative sound
                                    stopNegativeSound();
        
                                    // Clear the scanning timeout
                                    clearTimeout(scanTimeout);
        
                                    // Fetch the price associated with the barcode
                                    fetchPriceForBarcode(result.text);
                                }
                                if (err && !(err instanceof ZXing.NotFoundException)) {
                                    console.error(err);
                                }
                            });
                        } else {
                            console.error("No video input devices found.");
                            $('#message').html('<div class="alert alert-danger">لم يتم العثور على كاميرا!</div>');
                            stopNegativeSound(); // Stop the negative sound
                        }
                    })
                    .catch(err => {
                        console.error("Error listing video devices:", err);
                        $('#message').html('<div class="alert alert-danger">خطأ في الوصول إلى الكاميرا.</div>');
                        stopNegativeSound(); // Stop the negative sound
                    });
            });
        
            // Function to fetch the price for a given barcode
            function fetchPriceForBarcode(barcode) {
                db.products.where('barcode').equals(barcode).first().then(product => {
                    if (product) {
                        // Update the price input field and display
                        const formattedPrice = replaceCommaWithDot(product.price);
                        $('#price').val(formattedPrice);
                        $('#priceValue').text(formattedPrice); // Mirror the exact value
                        $('#message').html('<div class="alert alert-info">تم جلب تفاصيل المنتج بنجاح!</div>');
                    } else {
                        $('#message').html('<div class="alert alert-warning">المنتج غير موجود!</div>');
                        playNegativeSound(); // Play negative sound if product not found
                    }
                }).catch(error => {
                    $('#message').html('<div class="alert alert-danger">خطأ في جلب تفاصيل المنتج.</div>');
                    playNegativeSound(); // Play negative sound on error
                });
            }
        
            // Handle form actions
            $(".action-btn").on('click', function () {
                const action = $(this).val();
                const barcode = $('#barcode').val();
                const price = $('#price').val();
        
                switch (action) {
                    case 'create':
                        db.products.add({ barcode: barcode, price: price }).then(() => {
                            $('#message').html('<div class="alert alert-success">تم إنشاء المنتج بنجاح!</div>');
                            fetchAllProducts();
                        }).catch(error => {
                            $('#message').html('<div class="alert alert-danger">خطأ في إنشاء المنتج.</div>');
                            playNegativeSound();
                        });
                        break;
        
                    case 'read':
                        fetchAllProducts();
                        break;
        
                    case 'update':
                        db.products.where('barcode').equals(barcode).modify({ price: price }).then(updated => {
                            if (updated) {
                                $('#message').html('<div class="alert alert-success">تم تحديث المنتج بنجاح!</div>');
                                fetchAllProducts();
                            } else {
                                $('#message').html('<div class="alert alert-warning">المنتج غير موجود!</div>');
                                playNegativeSound();
                            }
                        }).catch(error => {
                            $('#message').html('<div class="alert alert-danger">خطأ في تحديث المنتج.</div>');
                            playNegativeSound();
                        });
                        break;
        
                    case 'delete':
                        db.products.where('barcode').equals(barcode).delete().then(deleted => {
                            if (deleted) {
                                $('#message').html('<div class="alert alert-success">تم حذف المنتج بنجاح!</div>');
                                fetchAllProducts();
                            } else {
                                $('#message').html('<div class="alert alert-warning">المنتج غير موجود!</div>');
                                playNegativeSound();
                            }
                        }).catch(error => {
                            $('#message').html('<div class="alert alert-danger">خطأ في حذف المنتج.</div>');
                            playNegativeSound();
                        });
                        break;
        
                    default:
                        $('#message').html('<div class="alert alert-warning">إجراء غير معروف.</div>');
                        playNegativeSound();
                        break;
                }
            });
        
            // Function to fetch all products and display them
            function fetchAllProducts() {
                db.products.toArray().then(products => {
                    let tableHtml = '<table class="table table-striped">';
                    tableHtml += '<thead><tr><th>ID</th><th>Barcode</th><th>Price</th></tr></thead><tbody>';
                    products.forEach(product => {
                        tableHtml += `<tr><td>${product.id}</td><td>${product.barcode}</td><td>${replaceCommaWithDot(product.price)}</td></tr>`;
                    });
                    tableHtml += '</tbody></table>';
                    $('#productList').html(tableHtml);
                }).catch(error => {
                    $('#message').html('<div class="alert alert-danger">خطأ في جلب المنتجات.</div>');
                    playNegativeSound();
                });
            }
        });
        </script>
</body>
</html>
